<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Meeting Room</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #181818;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #202020;
    padding: 8px 12px;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
  }
  #meetingTimer { font-weight: normal; color: #0f9d58; margin-left: 10px; }

  #top-strip {
    display: flex; gap: 10px;
    background: #111; padding: 8px;
    overflow-x: auto; scrollbar-width: thin;
  }
  .small-tile {
    flex: 0 0 120px; height: 90px;
    background: #2a2a2a; border-radius: 8px;
    position: relative; overflow: hidden;
    display: flex; justify-content: center; align-items: center;
  }
  .small-tile video, .small-tile img { width: 100%; height: 100%; object-fit: cover; }
  .name-label {
    position: absolute; bottom: 5px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 12px; font-size: 12px;
  }

  #main-speaker {
    flex: 1; display: flex; background: #000;
    justify-content: center; align-items: center; position: relative;
  }
  #main-speaker video, #main-speaker img {
    max-width: 95%; max-height: 95%; border-radius: 10px; background: #000; object-fit: cover;
  }
  #main-speaker .name-label { top: 10px; bottom: auto; background: rgba(0,0,0,0.7); }

  footer {
    background: #202020; padding: 8px 0;
    display: flex; justify-content: center; align-items: center; gap: 16px;
  }
  footer button {
    background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer;
    padding: 8px 14px; border-radius: 6px;
  }
  footer button:hover { background: rgba(255,255,255,0.1); }
  .end-btn { background: #cc1534; border-radius: 20px; font-weight: bold; }

  #chatbox {
    position: absolute; right: 10px; bottom: 60px; width: 250px; height: 250px;
    background: #fff; color: #000; border-radius: 8px;
    display: flex; flex-direction: column; overflow: hidden;
  }
  #chat-messages { flex: 1; padding: 6px; overflow-y: auto; font-size: 13px; }
  #chat-input { display: flex; border-top: 1px solid #ccc; }
  #chat-input input { flex: 1; padding: 6px; border: none; outline: none; }
  #chat-input button { background: #6a0dad; border: none; color: #fff; padding: 0 10px; cursor: pointer; }
</style>
</head>
<body>

<header>Meeting Room <span id="meetingTimer">00:00:00</span></header>
<div id="top-strip"></div>
<div id="main-speaker"><div class="name-label" id="mainSpeakerName"></div></div>

<footer>
  <button id="muteBtn">üé§ Mute</button>
  <button id="videoBtn">üì∑ Stop Video</button>
  <button id="screenBtn">üñ•Ô∏è Share Screen</button>
  <button id="avatarBtn">üßë Avatar</button>
  <button id="leaveBtn" class="end-btn">End Meeting</button>
</footer>

<div id="chatbox">
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="chatText" placeholder="Type a message...">
    <button id="sendChat">Send</button>
  </div>
</div>

<!-- Firebase Auth Integration -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBcrgAsbXlBtL_YQHMCqE4ppYODOInTB0g",
  authDomain: "twintalk-35672.firebaseapp.com",
  projectId: "twintalk-35672",
  storageBucket: "twintalk-35672.firebasestorage.app",
  messagingSenderId: "373581191413",
  appId: "1:373581191413:web:f3bb95f18f20dfe62b4dbc",
  measurementId: "G-CJMY9LJZ7Q"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log("‚úÖ Authenticated as", user.email);
    window.currentUser = user;
    setTimeout(() => startMeeting(user), 200);
  } else {
    console.warn("‚ö†Ô∏è Not logged in ‚Äî redirecting...");
    sessionStorage.setItem("postLoginRedirect", window.location.pathname + window.location.search);
    window.location.href = "/auth.html";
  }
});

async function startMeeting(user) {
  const socket = io();
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get('room') || 'default';
  const name = user.displayName || user.email.split("@")[0];
  const userEmail = (user.email || "unknown").toLowerCase();
  const savedAvatar = localStorage.getItem('userAvatar');
  const useAvatar = params.get('useAvatar') === 'true';

  let localStream = null;
  const peers = {};
  let meetingTranscript = "";
  let avatarMode = false;
  let originalVideoTrack = null;
  let avatarStream = null;
  let canvas = null, ctx = null;

  const timerDisplay = document.getElementById('meetingTimer');
  const startTime = Date.now();
  setInterval(() => {
    const elapsed = Date.now() - startTime;
    const h = Math.floor(elapsed / 3600000);
    const m = Math.floor((elapsed % 3600000) / 60000);
    const s = Math.floor((elapsed % 60000) / 1000);
    timerDisplay.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }, 1000);

  function createSmallTile(id,label,stream,avatarURL){
    let tile = document.getElementById('tile-'+id);
    if(!tile){
      tile = document.createElement('div');
      tile.className = 'small-tile';
      tile.id = 'tile-'+id;
      if(stream){
        const video = document.createElement('video');
        video.autoplay = true; video.playsInline = true;
        if(id==='me') video.muted = true;
        video.srcObject = stream;
        tile.appendChild(video);
      } else if(avatarURL){
        const img = document.createElement('img');
        img.src = avatarURL; tile.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.style.cssText='width:100%;height:100%;display:flex;justify-content:center;align-items:center;color:#999';
        placeholder.textContent='No video';tile.appendChild(placeholder);
      }
      const lbl=document.createElement('div');
      lbl.className='name-label';lbl.textContent=label;
      tile.appendChild(lbl);
      document.getElementById('top-strip').appendChild(tile);
    } else {
      if(stream){
        tile.innerHTML=`<video autoplay playsinline ${id==='me'?'muted':''}></video><div class="name-label">${label}</div>`;
        tile.querySelector('video').srcObject=stream;
      } else if(avatarURL){
        tile.innerHTML=`<img src="${avatarURL}"><div class="name-label">${label}</div>`;
      }
    }
  }

  function setMainSpeaker(id,label,stream,avatarURL){
    const main=document.getElementById('main-speaker');
    if(stream){
      main.innerHTML=`<video autoplay playsinline ${id==='me'?'muted':''}></video><div class="name-label">${label}</div>`;
      main.querySelector('video').srcObject=stream;
    } else if(avatarURL){
      main.innerHTML=`<img src="${avatarURL}"><div class="name-label">${label}</div>`;
    } else {
      main.innerHTML=`<div style="width:80%;height:60%;display:flex;align-items:center;justify-content:center;color:#999">No active video</div><div class="name-label">${label}</div>`;
    }
  }

  async function initMedia(){
    try{
      localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      createSmallTile('me', name+' (You)', localStream, null);
      setMainSpeaker('me', name+' (You)', localStream, null);
      originalVideoTrack=localStream.getVideoTracks()[0]||null;
      if(useAvatar && savedAvatar) await enableAvatarMode(savedAvatar);
    }catch(e){
      console.warn("getUserMedia error:",e);
    }
  }

  async function enableAvatarMode(avatarURL){
    if(!localStream){
      try{localStream=await navigator.mediaDevices.getUserMedia({audio:true});}catch(e){}
    }
    if(!canvas){canvas=document.createElement('canvas');canvas.width=640;canvas.height=360;ctx=canvas.getContext('2d');}
    const img=new Image();img.crossOrigin="anonymous";img.src=avatarURL;await img.decode();
    ctx.fillStyle="#000";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0,canvas.width,canvas.height);
    avatarStream=canvas.captureStream(15);
    const avatarTrack=avatarStream.getVideoTracks()[0];
    for(const pc of Object.values(peers)){
      const sender=pc.getSenders().find(s=>s.track&&s.track.kind==="video");
      if(sender&&avatarTrack)await sender.replaceTrack(avatarTrack);
    }
    createSmallTile('me',name+' (Avatar)',null,avatarURL);
    setMainSpeaker('me',name+' (Avatar)',null,avatarURL);
    avatarMode=true;meetingTranscript="";
    startSpeechRecognition();
    socket.emit("set-avatar",{roomId,avatar:avatarURL,name});
  }

  async function disableAvatarMode(){
    if(originalVideoTrack){
      for(const pc of Object.values(peers)){
        const sender=pc.getSenders().find(s=>s.track&&s.track.kind==="video");
        if(sender)await sender.replaceTrack(originalVideoTrack);
      }
    }
    if(localStream){
      createSmallTile('me',name+' (You)',localStream,null);
      setMainSpeaker('me',name+' (You)',localStream,null);
    }
    avatarMode=false;if(recognition){recognition.stop();recognition=null;}
    if(meetingTranscript.trim().length>0 && userEmail!=="unknown"){
      await window.saveSummaryToSupabase(roomId,meetingTranscript.trim(),userEmail);
      meetingTranscript="";
    }
  }

  let recognition;
  function startSpeechRecognition(){
    if(!('webkitSpeechRecognition'in window||'SpeechRecognition'in window))return;
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    recognition=new SR();recognition.lang='en-IN';recognition.continuous=true;recognition.interimResults=false;
    recognition.onresult=e=>{for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal){meetingTranscript+=e.results[i][0].transcript.trim()+". ";}}};
    recognition.onend=()=>{if(avatarMode){try{recognition.start();}catch(e){}}};
    recognition.start();
  }

  function createPeerConnection(peerId){
    const pc=new RTCPeerConnection({
      iceServers:[
        {urls:"stun:stun.l.google.com:19302"},
        {urls:"stun:stun1.l.google.com:19302"},
        {urls:"stun:stun2.l.google.com:19302"}
      ]
    });

    if(localStream){
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    }

    pc.ontrack=e=>{
      createSmallTile(peerId,'User '+peerId.slice(0,5),e.streams[0],null);
      setMainSpeaker(peerId,'User '+peerId.slice(0,5),e.streams[0],null);
    };

    pc.onicecandidate=e=>{
      if(e.candidate){
        socket.emit('webrtc-ice-candidate',{to:peerId,candidate:e.candidate});
      }
    };

    peers[peerId]=pc;
    return pc;
  }

  async function callPeer(peerId){
    const pc=createPeerConnection(peerId);
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('webrtc-offer',{to:peerId,sdp:offer});
  }

  socket.on('connect',async()=>{await initMedia();socket.emit('join-room',{roomId,name});});

  socket.on('existing-peers',async({peers:existing})=>{
    for(const p of existing){
      const id=typeof p==="string"?p:p.peerId;
      if(id&&id!==socket.id)await callPeer(id);
    }
  });

  socket.on('peer-joined',({peerId,name:peerName})=>{console.log('peer joined',peerId,peerName);});

  socket.on('webrtc-offer',async({from,sdp})=>{
    const pc=createPeerConnection(from);
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('webrtc-answer',{to:from,sdp:answer});
  });

  socket.on('webrtc-answer',async({from,sdp})=>{
    const pc=peers[from];
    if(pc)await pc.setRemoteDescription(new RTCSessionDescription(sdp));
  });

  socket.on('webrtc-ice-candidate',async({from,candidate})=>{
    const pc=peers[from];
    if(pc&&candidate)await pc.addIceCandidate(new RTCIceCandidate(candidate));
  });

  socket.on('peer-left',({peerId})=>{
    const tile=document.getElementById('tile-'+peerId);
    if(tile)tile.remove();
    if(peers[peerId]){try{peers[peerId].close();}catch(e){}delete peers[peerId];}
  });

  socket.on('peer-avatar',({peerId,avatar,name:peerName})=>{
    createSmallTile(peerId,peerName+" (Avatar)",null,avatar);
    setMainSpeaker(peerId,peerName+" (Avatar)",null,avatar);
  });

  document.getElementById('muteBtn').onclick=()=>{if(localStream){const t=localStream.getAudioTracks()[0];if(t)t.enabled=!t.enabled;}};
  document.getElementById('videoBtn').onclick=()=>{if(avatarMode){disableAvatarMode();}else if(localStream){const t=localStream.getVideoTracks()[0];if(t)t.enabled=!t.enabled;}};
  document.getElementById('screenBtn').onclick=async()=>{try{const screen=await navigator.mediaDevices.getDisplayMedia({video:true});const track=screen.getVideoTracks()[0];for(const pc of Object.values(peers)){const sender=pc.getSenders().find(s=>s.track&&s.track.kind==='video');if(sender)sender.replaceTrack(track);}setMainSpeaker('me',name+' (You)',screen,null);track.onended=()=>{if(localStream){const cam=localStream.getVideoTracks()[0];for(const pc of Object.values(peers)){const sender=pc.getSenders().find(s=>s.track&&s.track.kind==='video');if(sender)sender.replaceTrack(cam);}setMainSpeaker('me',name+' (You)',localStream,null);}};}catch(e){console.log(e);}};

  document.getElementById('avatarBtn').onclick=async()=>{if(!avatarMode&&savedAvatar){await enableAvatarMode(savedAvatar);}else if(avatarMode){await disableAvatarMode();}else{window.location.href=`avatar.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(name)}`;}};

  document.getElementById('leaveBtn').onclick=async()=>{if(recognition)recognition.stop();Object.values(peers).forEach(pc=>pc.close());if(localStream)localStream.getTracks().forEach(t=>t.stop());if(meetingTranscript.trim().length>0&&userEmail!=="unknown"){await window.saveSummaryToSupabase(roomId,meetingTranscript.trim(),userEmail);}window.location.href='/index.html';};

  const chatMessages=document.getElementById('chat-messages');const chatInput=document.getElementById('chatText');
  document.getElementById('sendChat').onclick=()=>{const msg=chatInput.value.trim();if(!msg)return;socket.emit('chat-message',{roomId,name,message:msg});chatInput.value='';};
  socket.on('chat-message',({name:sender,message})=>{const d=document.createElement('div');d.textContent=`${sender}: ${message}`;chatMessages.appendChild(d);chatMessages.scrollTop=chatMessages.scrollHeight;});
}
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Meeting Room</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#f3e9ff; font-family: Arial, sans-serif; margin:0; padding:0; }
    .meeting-container { max-width:1200px; margin:0 auto; padding:20px; }
    h1 { text-align:center; margin:10px 0 0; }
    #videos {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px; margin-top:16px;
    }
    video, img.avatar {
      width:100%; aspect-ratio:16/9; object-fit:cover; background:#000;
      border-radius:12px;
    }
    .tile { position:relative; }
    .label {
      position:absolute; left:8px; bottom:8px; padding:4px 8px; border-radius:6px;
      background:rgba(0,0,0,0.5); color:#fff; font-size:12px;
    }
    .controls { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    button { padding:10px 14px; border:none; border-radius:8px; background:#6a0dad; color:#fff; cursor:pointer; }
    button:hover { background:#520c9c; }
    .chatbox { margin:18px auto 0; width:min(740px, 95%); background:#fff; border:1px solid #ccc; border-radius:10px; padding:10px; }
    .chat-messages { height:200px; overflow-y:auto; border-bottom:1px solid #eee; padding:6px; text-align:left; }
    .chat-input { display:flex; gap:6px; margin-top:10px; }
    .chat-input input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }
    .emoji-bar { margin-top:10px; text-align:center; }
    .emoji-panel { display:none; margin-top:8px; max-height:160px; overflow-y:auto; background:#fff; border:1px solid #ccc; border-radius:8px; padding:8px; font-size:20px; text-align:left; }
    .emoji-panel span { cursor:pointer; padding:6px; display:inline-block; }
    .emoji-panel span:hover { background:#f0f0f0; border-radius:4px; }
  </style>

  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="meeting-container">
    <h1>Meeting Room</h1>

    <div id="videos"></div>

    <div class="controls">
      <button id="muteBtn">ğŸ¤ Mute</button>
      <button id="videoBtn">ğŸ“· Stop Video</button>
      <button id="screenBtn">ğŸ–¥ï¸ Share Screen</button>
      <button id="avatarBtn">ğŸ§‘ Avatar</button>
      <button id="leaveBtn" style="background:#cc1534;">End Meeting</button>
    </div>

    <div class="emoji-bar">
      <button class="quick-emoji">ğŸ‘</button>
      <button class="quick-emoji">ğŸ˜‚</button>
      <button class="quick-emoji">ğŸ‘</button>
      <button class="quick-emoji">â¤ï¸</button>
    </div>

    <div class="chatbox">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

<script>
const socket = io();

// Get room and name
const params = new URLSearchParams(window.location.search);
const roomId = params.get('room') || 'default';
const username = params.get('name') || localStorage.getItem('username') || 'Guest';

let localStream;
const peers = {};
const peerNames = {}; // store peer names

const videosDiv = document.getElementById('videos');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');

const rtcConfig = {
  iceServers: [
    { urls: ["stun:bn-turn1.xirsys.com"] },
    {
      username: "9vPc46D2ulxFRkRBW-g2drEOHQp3FYwqstrpoR1Ar-SRTS3NmWDUuFDl33686Tu0AAAAAGjiKYtzeWVkYW5heml5YQ==",
      credential: "b4003654-a1c3-11f0-a3eb-0242ac140004",
      urls: [
        "turn:bn-turn1.xirsys.com:80?transport=udp",
        "turn:bn-turn1.xirsys.com:3478?transport=udp",
        "turn:bn-turn1.xirsys.com:80?transport=tcp",
        "turn:bn-turn1.xirsys.com:3478?transport=tcp",
        "turns:bn-turn1.xirsys.com:443?transport=tcp",
        "turns:bn-turn1.xirsys.com:5349?transport=tcp"
      ]
    }
  ]
};

// UI helpers
function addVideoTile(id, label, stream, isLocal=false){
  let tile = document.getElementById(`tile-${id}`);
  if(!tile){
    tile = document.createElement('div');
    tile.className = 'tile';
    tile.id = `tile-${id}`;
    const video = document.createElement('video');
    video.autoplay = true;
    video.playsInline = true;
    if(isLocal) video.muted = true;
    video.id = `video-${id}`;
    tile.appendChild(video);
    const tag = document.createElement('div');
    tag.className = 'label';
    tag.textContent = label;
    tile.appendChild(tag);
    videosDiv.appendChild(tile);
  }
  if(stream){
    document.getElementById(`video-${id}`).srcObject = stream;
  }
}

function removeVideoTile(id){
  const el = document.getElementById(`tile-${id}`);
  if(el) el.remove();
}

function logChat(msg){
  const d = document.createElement('div');
  d.textContent = msg;
  chatMessages.appendChild(d);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// media
async function initMedia(){
  try{
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    addVideoTile('me', `${username} (You)`, localStream,true);
  }catch(e){
    alert('Could not get camera/mic: '+e);
  }
}

// peers
function createPeerConnection(peerId, peerLabel){
  const pc = new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

  pc.ontrack = e=>{
    const displayName = peerNames[peerId] || peerLabel || `User ${peerId.slice(0,5)}`;
    addVideoTile(peerId, displayName, e.streams[0]);
  };

  pc.onicecandidate = e=>{
    if(e.candidate){
      socket.emit('webrtc-ice-candidate',{to:peerId,candidate:e.candidate});
    }
  };

  pc.onconnectionstatechange = ()=>{
    if(['disconnected','failed','closed'].includes(pc.connectionState)){
      removeVideoTile(peerId);
      pc.close();
      delete peers[peerId];
      delete peerNames[peerId];
    }
  };
  peers[peerId]=pc;
  return pc;
}

async function callPeer(peerId, peerLabel){
  const pc = createPeerConnection(peerId, peerLabel);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('webrtc-offer',{to:peerId,sdp:offer});
}

// socket events
socket.on('connect',async()=>{
  await initMedia();
  socket.emit('join-room',{roomId,name:username});
});

socket.on('existing-peers', async ({peers:existing})=>{
  for(const p of existing){
    await callPeer(p);
  }
});

socket.on('peer-joined', ({peerId,name})=>{
  peerNames[peerId] = name; // store the peerâ€™s actual name
  callPeer(peerId, name);
});

socket.on('webrtc-offer',async({from,sdp})=>{
  const pc = createPeerConnection(from, peerNames[from]);
  await pc.setRemoteDescription(new RTCSessionDescription(sdp));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit('webrtc-answer',{to:from,sdp:answer});
});

socket.on('webrtc-answer',async({from,sdp})=>{
  const pc = peers[from];
  if(pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp));
});

socket.on('webrtc-ice-candidate',async({from,candidate})=>{
  const pc = peers[from];
  if(pc && candidate) await pc.addIceCandidate(new RTCIceCandidate(candidate));
});

socket.on('peer-left',({peerId})=>{
  removeVideoTile(peerId);
  if(peers[peerId]) peers[peerId].close();
  delete peers[peerId];
  delete peerNames[peerId];
});

// controls
document.getElementById('muteBtn').onclick=()=>{
  const t = localStream.getAudioTracks()[0];
  if(!t) return;
  t.enabled=!t.enabled;
  document.getElementById('muteBtn').textContent=t.enabled?'ğŸ¤ Mute':'ğŸ”‡ Unmute';
};

document.getElementById('videoBtn').onclick=()=>{
  const t = localStream.getVideoTracks()[0];
  if(!t) return;
  t.enabled=!t.enabled;
  document.getElementById('videoBtn').textContent=t.enabled?'ğŸ“· Stop Video':'ğŸš« Start Video';
};

document.getElementById('leaveBtn').onclick=()=>{
  Object.values(peers).forEach(pc=>pc.close());
  localStream.getTracks().forEach(t=>t.stop());
  window.location.href='/index.html';
};

// chat
document.getElementById('sendBtn').onclick=()=>{
  const msg = chatInput.value.trim();
  if(!msg) return;
  socket.emit('chat-message',{roomId,name:username,message:msg});
  logChat(`${username}: ${msg}`);
  chatInput.value='';
};

// receive chat from others
socket.on('chat-message',({name,message})=>{
  logChat(`${name}: ${message}`);
});

// emoji
document.querySelectorAll('.quick-emoji').forEach(b=>{
  b.onclick=()=>{
    const emoji = b.textContent;
    socket.emit('emoji',{roomId,name:username,emoji});
    logChat(`${username} reacted ${emoji}`);
  };
});

socket.on('emoji',({name,emoji})=>{
  logChat(`${name} reacted ${emoji}`);
});
</script>
</body>
</html>

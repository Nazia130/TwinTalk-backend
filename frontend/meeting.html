<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Meeting Room</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#f3e9ff; font-family: Arial, sans-serif; margin:0; padding:0; }
    .meeting-container { max-width:1200px; margin:0 auto; padding:20px; }
    h1 { text-align:center; margin:10px 0 0; }
    #videos {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px; margin-top:16px;
    }
    video, img.avatar {
      width:100%; aspect-ratio:16/9; object-fit:cover; background:#000;
      border-radius:12px;
    }
    .tile { position:relative; }
    .label {
      position:absolute; left:8px; bottom:8px; padding:4px 8px; border-radius:6px;
      background:rgba(0,0,0,0.5); color:#fff; font-size:12px;
    }
    .controls { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    button { padding:10px 14px; border:none; border-radius:8px; background:#6a0dad; color:#fff; cursor:pointer; }
    button:hover { background:#520c9c; }
    .chatbox { margin:18px auto 0; width:min(740px, 95%); background:#fff; border:1px solid #ccc; border-radius:10px; padding:10px; }
    .chat-messages { height:200px; overflow-y:auto; border-bottom:1px solid #eee; padding:6px; text-align:left; }
    .chat-input { display:flex; gap:6px; margin-top:10px; }
    .chat-input input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }
    .emoji-bar { margin-top:10px; text-align:center; }
    .emoji-panel { display:none; margin-top:8px; max-height:160px; overflow-y:auto; background:#fff; border:1px solid #ccc; border-radius:8px; padding:8px; font-size:20px; text-align:left; }
    .emoji-panel span { cursor:pointer; padding:6px; display:inline-block; }
    .emoji-panel span:hover { background:#f0f0f0; border-radius:4px; }
  </style>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <div class="meeting-container">
    <h1>Meeting Room</h1>

    <div id="videos"></div>

    <div class="controls">
      <button id="muteBtn">🎤 Mute</button>
      <button id="videoBtn">📷 Stop Video</button>
      <button id="screenBtn">🖥️ Share Screen</button>
      <button id="avatarBtn">🧑 Avatar</button>
      <button id="leaveBtn" style="background:#cc1534;">End Meeting</button>
    </div>

    <div class="emoji-bar">
      <button class="quick-emoji">👍</button>
      <button class="quick-emoji">😂</button>
      <button class="quick-emoji">👏</button>
      <button class="quick-emoji">❤️</button>
      <button id="moreEmojiBtn">➕</button>
      <div id="emojiPanel" class="emoji-panel">
        😀 😁 😂 🤣 😃 😄 😅 😆 😉 😊 😋 😎 😍 😘 😗 😙 😚 🥰 🤩 😜 😝 😛
        🤑 🤗 🤔 🤨 😐 😑 😶 🙄 😏 😣 😥 😮 🤐 😯 😪 😫 😴 😌 🤤 😓 😔 😕
        🙃 🥺 😢 😭 😤 😠 😡 🤬 🤯 😳 🥵 🥶 😱 😨 😰 😥 😓 🤒 🤕 🤢 🤮 🤧
        😷 🥴 😵 🤯 🤠 🥳 😇 🤡 👻 💀 ☠️ 👽 🤖 🎃
      </div>
    </div>

    <div class="chatbox">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  const socket = io();
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get('room') || 'default';
  const name = params.get('name') || localStorage.getItem('username') || 'Guest';
  const useAvatarParam = params.get('useAvatar') === 'true';
  const savedAvatar = localStorage.getItem('userAvatar') || null;

  const videosDiv = document.getElementById('videos');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');

  let localStream = null;
  let cameraStream = null;
  let isScreenSharing = false;
  let audioEnabled = true;
  let videoEnabled = true;
  const peers = {};
  const peerVideos = {};

  const rtcConfig = {
    iceServers: [
      { urls: ["stun:bn-turn1.xirsys.com"] },
      {
        username: "9vPc46D2ulxFRkRBW-g2drEOHQp3FYwqstrpoR1Ar-SRTS3NmWDUuFDl33686Tu0AAAAAGjiKYtzeWVkYW5heml5YQ==",
        credential: "b4003654-a1c3-11f0-a3eb-0242ac140004",
        urls: [
          "turn:bn-turn1.xirsys.com:80?transport=udp",
          "turn:bn-turn1.xirsys.com:3478?transport=udp",
          "turn:bn-turn1.xirsys.com:80?transport=tcp",
          "turn:bn-turn1.xirsys.com:3478?transport=tcp",
          "turns:bn-turn1.xirsys.com:443?transport=tcp",
          "turns:bn-turn1.xirsys.com:5349?transport=tcp"
        ]
      }
    ]
  };

  function addVideoTile(id, label, stream, isLocal=false, isAvatar=false) {
    let outer = document.getElementById(`tile-${id}`);
    if (!outer) {
      outer = document.createElement('div');
      outer.className = 'tile';
      outer.id = `tile-${id}`;

      const v = isAvatar ? document.createElement('img') : document.createElement('video');
      v.id = (id === 'me') ? 'video-me' : `video-${id}`;
      if (!isAvatar) {
        v.autoplay = true;
        v.playsInline = true;
        if (isLocal) v.muted = true;
      } else {
        v.className = 'avatar';
      }
      outer.appendChild(v);

      const tag = document.createElement('div');
      tag.className = 'label';
      tag.textContent = label;
      outer.appendChild(tag);

      videosDiv.appendChild(outer);
    }
    const el = document.getElementById(id === 'me' ? 'video-me' : `video-${id}`);
    if (stream && el.tagName === 'VIDEO') el.srcObject = stream;
  }

  function removeVideoTile(id) {
    const el = document.getElementById(`tile-${id}`);
    if (el) el.remove();
  }

  function logChat(text) {
    const div = document.createElement('div');
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function initLocalMedia() {
    try {
      if (useAvatarParam && savedAvatar) {
        try { localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false }); }
        catch { localStream = new MediaStream(); }
        addVideoTile('me', `${name} (You)`, null, true, true);
      } else {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localStream = cameraStream;
        addVideoTile('me', `${name} (You)`, localStream, true);
      }
    } catch (e) {
      alert("Camera/mic error: " + e);
      localStream = new MediaStream();
      addVideoTile('me', `${name} (You)`, null, true, true);
    }
  }

  function createPeerConnection(peerId) {
    const pc = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = e => {
      const [remoteStream] = e.streams;
      addVideoTile(peerId, `User ${peerId.slice(0,5)}`, remoteStream);
      peerVideos[peerId] = remoteStream;
    };

    pc.onicecandidate = e => {
      if (e.candidate) socket.emit("webrtc-ice-candidate", { to: peerId, candidate: e.candidate });
    };

    pc.onconnectionstatechange = () => {
      if (['failed','disconnected','closed'].includes(pc.connectionState)) {
        removeVideoTile(peerId);
        pc.close(); delete peers[peerId];
      }
    };
    peers[peerId] = pc;
    return pc;
  }

  async function callPeer(peerId) {
    const pc = createPeerConnection(peerId);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("webrtc-offer", { to: peerId, sdp: offer });
  }

  socket.on("connect", async () => {
    await initLocalMedia();
    socket.emit("join-room", { roomId, name });
  });

  socket.on("existing-peers", async ({ peers: existing }) => {
    for (const p of existing) await callPeer(p);
  });

  socket.on("peer-joined", async ({ peerId }) => {
    await callPeer(peerId);
  });

  socket.on("webrtc-offer", async ({ from, sdp }) => {
    const pc = createPeerConnection(from);
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("webrtc-answer", { to: from, sdp: answer });
  });

  socket.on("webrtc-answer", async ({ from, sdp }) => {
    const pc = peers[from];
    if (pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp));
  });

  socket.on("webrtc-ice-candidate", async ({ from, candidate }) => {
    const pc = peers[from];
    if (pc && candidate) await pc.addIceCandidate(new RTCIceCandidate(candidate));
  });

  socket.on("peer-left", ({ peerId }) => {
    removeVideoTile(peerId);
    if (peers[peerId]) peers[peerId].close();
    delete peers[peerId];
  });

  document.getElementById('muteBtn').onclick = () => {
    const t = localStream.getAudioTracks()[0];
    if (!t) return;
    t.enabled = !t.enabled;
    document.getElementById('muteBtn').textContent = t.enabled ? '🎤 Mute' : '🔇 Unmute';
  };

  document.getElementById('videoBtn').onclick = () => {
    const t = localStream.getVideoTracks()[0];
    if (!t) return;
    t.enabled = !t.enabled;
    document.getElementById('videoBtn').textContent = t.enabled ? '📷 Stop Video' : '🚫 Start Video';
  };

  document.getElementById('leaveBtn').onclick = () => {
    Object.values(peers).forEach(pc => pc.close());
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    window.location.href = '/index.html';
  };

  document.getElementById('sendBtn').onclick = () => {
    const msg = chatInput.value.trim();
    if (!msg) return;
    socket.emit('chat-message', { roomId, name, message: msg });
    logChat(`${name}: ${msg}`);
    chatInput.value = '';
  };

  document.querySelectorAll('.quick-emoji').forEach(b => {
    b.onclick = () => {
      const emoji = b.textContent;
      socket.emit('emoji', { roomId, name, emoji });
      logChat(`${name} reacted ${emoji}`);
    };
  });
  </script>
</body>
</html>

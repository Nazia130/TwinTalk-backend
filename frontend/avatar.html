<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Select Avatar | TwinTalk</title>
  
  <!-- ‚úÖ 3D Avatar Support -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  
  <style>
    :root {
      --primary-color: #0f9d58;
      --secondary-color: #4285f4;
      --danger-color: #cc1534;
      --dark-bg: #181818;
      --darker-bg: #111;
      --card-bg: #2a2a2a;
      --text-light: #ffffff;
      --text-muted: #aaaaaa;
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px 0;
    }

    .logo {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 16px;
      margin-bottom: 30px;
    }

    /* Avatar Grid */
    .avatar-section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 20px;
      text-align: center;
      position: relative;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 2px;
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .avatar-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .avatar-card:hover {
      transform: translateY(-5px);
      border-color: var(--primary-color);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .avatar-card.selected {
      border-color: var(--primary-color);
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(15, 157, 88, 0.1) 100%);
    }

    .avatar-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 12px;
      border: 3px solid rgba(255,255,255,0.1);
      transition: var(--transition);
    }

    .avatar-card:hover .avatar-image {
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .avatar-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .avatar-type {
      font-size: 12px;
      color: var(--text-muted);
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-block;
    }

    /* 3D Avatar Section */
    .model-viewer-container {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
      margin-bottom: 30px;
    }

    .model-viewer-container:hover {
      transform: translateY(-5px);
      border-color: var(--secondary-color);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    model-viewer {
      width: 200px;
      height: 200px;
      margin: 0 auto;
      border-radius: var(--border-radius);
      background: #000;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 30px;
      border-radius: 25px;
      border: none;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #0d8a4d;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(15, 157, 88, 0.3);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #3367d6;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-muted);
      border: 2px solid var(--text-muted);
    }

    .btn-outline:hover {
      color: var(--text-light);
      border-color: var(--text-light);
      transform: translateY(-2px);
    }

    /* Selection Indicator */
    .selection-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: var(--transition);
    }

    .avatar-card.selected .selection-indicator {
      opacity: 1;
    }

    .selection-indicator::after {
      content: '‚úì';
      color: white;
      font-size: 14px;
      font-weight: bold;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .avatar-grid {
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 15px;
      }
      
      .avatar-image {
        width: 80px;
        height: 80px;
      }
      
      model-viewer {
        width: 150px;
        height: 150px;
      }
      
      .btn {
        padding: 10px 20px;
        min-width: 120px;
      }
    }

    @media (max-width: 480px) {
      .avatar-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 200px;
      }
    }

    /* Loading State */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Success Animation */
    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .success {
      animation: successPulse 0.6s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">TwinTalk</div>
      <h1>Choose Your Avatar</h1>
      <div class="subtitle">Select an avatar to represent you in the meeting</div>
    </div>

    <!-- 2D Avatars Section -->
    <div class="avatar-section">
      <h2 class="section-title">2D Avatars</h2>
      <div class="avatar-grid" id="avatarGrid">
        <!-- Male Avatars -->
        <div class="avatar-card" data-avatar="male1">
          <div class="selection-indicator"></div>
          <img src="https://tse4.mm.bing.net/th/id/OIP._8y_AjgfPlCos61q1924LgHaHa?pid=Api&P=0&h=180" alt="Male Professional" class="avatar-image">
          <div class="avatar-name">Alex</div>
          <div class="avatar-type">Professional</div>
        </div>
        
        <div class="avatar-card" data-avatar="male2">
          <div class="selection-indicator"></div>
          <img src="https://tse4.mm.bing.net/th/id/OIP.IkLYdobJ8Ux8CAX0AfuXIQHaHa?pid=Api&P=0&h=180" alt="Male Casual" class="avatar-image">
          <div class="avatar-name">Marcus</div>
          <div class="avatar-type">Casual</div>
        </div>
        
        <!-- Female Avatars -->
        <div class="avatar-card" data-avatar="female1">
          <div class="selection-indicator"></div>
          <img src="https://img.freepik.com/vector-premium/ilustracion-vectorial-perfil-avatar-mujer-linda_1058532-14546.jpg" alt="Female Professional" class="avatar-image">
          <div class="avatar-name">Sophia</div>
          <div class="avatar-type">Professional</div>
        </div>
        
        <div class="avatar-card" data-avatar="female2">
          <div class="selection-indicator"></div>
          <img src="https://static.vecteezy.com/system/resources/previews/019/837/194/original/smile-american-african-businesswoman-avatar-curly-hair-woman-face-profile-icon-concept-online-support-service-female-cartoon-character-portrait-isolated-flat-icon-png.png" alt="Female Casual" class="avatar-image">
          <div class="avatar-name">Zoe</div>
          <div class="avatar-type">Casual</div>
        </div>

        <!-- Additional Avatars for better grid -->
        <div class="avatar-card" data-avatar="male3">
          <div class="selection-indicator"></div>
          <img src="https://cdn-icons-png.flaticon.com/512/4333/4333609.png" alt="Male Executive" class="avatar-image">
          <div class="avatar-name">James</div>
          <div class="avatar-type">Executive</div>
        </div>
        
        <div class="avatar-card" data-avatar="female3">
          <div class="selection-indicator"></div>
          <img src="https://cdn-icons-png.flaticon.com/512/6997/6997662.png" alt="Female Executive" class="avatar-image">
          <div class="avatar-name">Emma</div>
          <div class="avatar-type">Executive</div>
        </div>
      </div>
    </div>

    <!-- 3D Avatar Section -->
    <div class="avatar-section">
      <h2 class="section-title">3D Avatar</h2>
      <div class="model-viewer-container" id="modelViewer">
        <div class="selection-indicator"></div>
        <model-viewer 
          src="character_avatar.glb" 
          alt="3D Avatar"
          camera-controls 
          auto-rotate
          exposure="1.0"
          environment-image="neutral"
          shadow-intensity="1">
        </model-viewer>
        <div class="avatar-name" style="margin-top: 15px;">3D Character</div>
        <div class="avatar-type">Interactive Model</div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn btn-outline" onclick="goBack()">
        <span>‚Üê</span>
        Back to Meeting
      </button>
      <button class="btn btn-primary" id="useAvatarBtn" onclick="useSelectedAvatar()" disabled>
        <span>‚úÖ</span>
        Use Selected Avatar
      </button>
      <button class="btn btn-secondary" onclick="clearAvatar()">
        <span>üö´</span>
        Remove Avatar
      </button>
    </div>
  </div>

<script>
  /* -------------------------
     1Ô∏è‚É£ Auth Guard
  -------------------------- */
  const user = (() => { 
    try { 
      return JSON.parse(sessionStorage.getItem("user")); 
    } catch(e){ 
      return null; 
    } 
  })();
  
  if (!user || !user.email) {
    alert("Please login first to select an avatar.");
    window.location.href = "auth.html";
  }

  /* -------------------------
     2Ô∏è‚É£ Params & Elements
  -------------------------- */
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get('room') || '';
  const userName = params.get('name') || user.name || user.email.split('@')[0];
  
  let selectedAvatar = null;
  let selectedType = null; // '2d' or '3d'

  /* -------------------------
     3Ô∏è‚É£ Initialize Page
  -------------------------- */
  document.addEventListener('DOMContentLoaded', function() {
    initializeAvatarSelection();
    loadCurrentAvatar();
  });

  function initializeAvatarSelection() {
    // Add click listeners to 2D avatar cards
    const avatarCards = document.querySelectorAll('.avatar-card');
    avatarCards.forEach(card => {
      card.addEventListener('click', function() {
        select2DAvatar(this);
      });
    });

    // Add click listener to 3D model viewer
    const modelViewer = document.getElementById('modelViewer');
    modelViewer.addEventListener('click', function() {
      select3DAvatar();
    });
  }

  function loadCurrentAvatar() {
    const currentAvatar = localStorage.getItem('userAvatar');
    if (currentAvatar) {
      // Check if current avatar matches any of our preset avatars
      const avatarCards = document.querySelectorAll('.avatar-card');
      let foundMatch = false;
      
      avatarCards.forEach(card => {
        const img = card.querySelector('img');
        if (img && img.src === currentAvatar) {
          select2DAvatar(card);
          foundMatch = true;
        }
      });
      
      // If no match found but there's a saved avatar, enable the use button
      if (!foundMatch && currentAvatar.includes('character_avatar.glb')) {
        select3DAvatar();
      } else if (!foundMatch) {
        // Some other avatar is selected, enable the button
        enableUseButton();
      }
    }
  }

  /* -------------------------
     4Ô∏è‚É£ Avatar Selection
  -------------------------- */
  function select2DAvatar(cardElement) {
    // Remove selection from all cards
    document.querySelectorAll('.avatar-card, .model-viewer-container').forEach(el => {
      el.classList.remove('selected');
    });
    
    // Add selection to clicked card
    cardElement.classList.add('selected');
    cardElement.classList.add('success');
    
    // Get the avatar image source
    const img = cardElement.querySelector('img');
    selectedAvatar = img.src;
    selectedType = '2d';
    
    // Enable use button
    enableUseButton();
    
    // Remove success animation after delay
    setTimeout(() => {
      cardElement.classList.remove('success');
    }, 600);
  }

  function select3DAvatar() {
    // Remove selection from all cards
    document.querySelectorAll('.avatar-card, .model-viewer-container').forEach(el => {
      el.classList.remove('selected');
    });
    
    // Add selection to 3D model viewer
    const modelViewer = document.getElementById('modelViewer');
    modelViewer.classList.add('selected');
    modelViewer.classList.add('success');
    
    selectedAvatar = 'character_avatar.glb';
    selectedType = '3d';
    
    // Enable use button
    enableUseButton();
    
    // Remove success animation after delay
    setTimeout(() => {
      modelViewer.classList.remove('success');
    }, 600);
  }

  function enableUseButton() {
    const useButton = document.getElementById('useAvatarBtn');
    useButton.disabled = false;
    useButton.innerHTML = '<span>‚úÖ</span> Use Selected Avatar';
  }

  /* -------------------------
     5Ô∏è‚É£ Action Handlers
  -------------------------- */
  function useSelectedAvatar() {
    if (!selectedAvatar) {
      alert('Please select an avatar first.');
      return;
    }

    // Show loading state
    const useButton = document.getElementById('useAvatarBtn');
    useButton.innerHTML = '<span>‚è≥</span> Applying...';
    useButton.disabled = true;

    // Save to localStorage
    localStorage.setItem('userAvatar', selectedAvatar);
    
    // Add brief delay for better UX
    setTimeout(() => {
      cleanupStream();
      redirectToMeeting(true);
    }, 800);
  }

  function clearAvatar() {
    localStorage.removeItem('userAvatar');
    
    // Show confirmation
    const useButton = document.getElementById('useAvatarBtn');
    useButton.innerHTML = '<span>‚úÖ</span> Avatar Removed';
    useButton.disabled = true;
    
    // Remove selections
    document.querySelectorAll('.avatar-card, .model-viewer-container').forEach(el => {
      el.classList.remove('selected');
    });
    
    selectedAvatar = null;
    selectedType = null;
    
    // Redirect after brief delay
    setTimeout(() => {
      cleanupStream();
      redirectToMeeting(false);
    }, 1000);
  }

  function goBack() {
    cleanupStream();
    redirectToMeeting(false);
  }

  /* -------------------------
     6Ô∏è‚É£ Helpers
  -------------------------- */
  function cleanupStream() {
    // Clean up any media streams (though we removed webcam functionality)
    // This is kept for future compatibility
  }

  function redirectToMeeting(useAvatar) {
    const url = `meeting.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(userName)}${useAvatar ? "&useAvatar=true" : ""}`;
    window.location.href = url;
  }

  /* -------------------------
     7Ô∏è‚É£ Keyboard Navigation
  -------------------------- */
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      goBack();
    }
  });
</script>
</body>
</html>
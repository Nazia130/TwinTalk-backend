<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Select Avatar</title>
  <style>
    body { font-family: Arial, sans-serif; background:#181818; color:#fff; text-align:center; padding:18px; }
    h1 { color:#6a0dad; }
    h3 { margin-top:25px; color:#ddd; }
    .presets { display:flex; justify-content:center; gap:14px; flex-wrap:wrap; margin-bottom:14px; }
    .presets img, .presets model-viewer { width:120px; height:120px; object-fit:cover; border-radius:12px; cursor:pointer; border:2px solid transparent; background:#000; }
    .presets img:hover, .presets model-viewer:hover { border-color:#6a0dad; }

    #video { width:320px; height:240px; border-radius:8px; background:#000; display:block; margin:12px auto; }
    #canvas { display:none; width:320px; height:240px; border-radius:8px; margin:12px auto; }

    button { padding:10px 14px; border-radius:8px; border:none; background:#6a0dad; color:#fff; cursor:pointer; margin:6px; }
    button.gray { background:#555; }
    button:hover { background:#520c9c; }
  </style>

  <!-- âœ… Add model-viewer support -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <h1>Choose Your Avatar</h1>

  <h3>Preset Avatars</h3>
  <div class="presets">
    <img src="https://tse4.mm.bing.net/th/id/OIP._8y_AjgfPlCos61q1924LgHaHa?pid=Api&P=0&h=180" alt="Male 1" onclick="selectPreset(this.src)">
    <img src="https://tse4.mm.bing.net/th/id/OIP.IkLYdobJ8Ux8CAX0AfuXIQHaHa?pid=Api&P=0&h=180" alt="Male 2" onclick="selectPreset(this.src)">
    <img src="https://img.freepik.com/vector-premium/ilustracion-vectorial-perfil-avatar-mujer-linda_1058532-14546.jpg" alt="Female 1" onclick="selectPreset(this.src)">
    <img src="https://static.vecteezy.com/system/resources/previews/019/837/194/original/smile-american-african-businesswoman-avatar-curly-hair-woman-face-profile-icon-concept-online-support-service-female-cartoon-character-portrait-isolated-flat-icon-png.png" alt="Female 2" onclick="selectPreset(this.src)">

    <!-- âœ… GLB Model Avatar -->
    <model-viewer src="character_avatar.glb" alt="3D Avatar"
      camera-controls auto-rotate
      style="width:120px;height:120px;border-radius:12px;cursor:pointer;"
      onclick="selectGLB('character_avatar.glb')">
    </model-viewer>
  </div>

  <h3>Or Create Custom Avatar</h3>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" width="320" height="240"></canvas>

  <div>
    <button onclick="capture()">ðŸ“¸ Capture</button>
    <button id="saveBtn" onclick="saveCaptured()" style="display:none">âœ… Save & Use</button>
    <button class="gray" onclick="goBack()">â¬… Back</button>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get('room') || '';
  const userName = params.get('name') || localStorage.getItem('username') || 'Guest';

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let stream = null;

  // Start webcam preview
  navigator.mediaDevices.getUserMedia({ video:true, audio:false })
    .then(s => { stream = s; video.srcObject = s; })
    .catch(e => { console.warn("Camera not available:", e); });

  // Choose preset image avatar
  function selectPreset(src){
    localStorage.setItem('userAvatar', src);
    window.location.href = `meeting.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(userName)}&useAvatar=true`;
  }

  // Choose GLB 3D avatar
  function selectGLB(path){
    localStorage.setItem('userAvatar', path);
    window.location.href = `meeting.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(userName)}&useAvatar=true`;
  }

  // Capture webcam snapshot & apply cartoon effect
  function capture(){
    if(!video.videoWidth){ alert("Camera not ready."); return; }
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    // Cartoon effect
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const d = imgData.data, levels = 6;
    for(let i=0;i<d.length;i+=4){
      d[i]   = Math.floor(d[i] / (256/levels)) * (256/levels);
      d[i+1] = Math.floor(d[i+1] / (256/levels)) * (256/levels);
      d[i+2] = Math.floor(d[i+2] / (256/levels)) * (256/levels);
    }
    ctx.putImageData(imgData,0,0);

    document.getElementById('saveBtn').style.display = 'inline-block';
    video.style.display = 'none';
    canvas.style.display = 'block';
  }

  // Save captured snapshot as avatar
  function saveCaptured(){
    const dataUrl = canvas.toDataURL('image/png');
    localStorage.setItem('userAvatar', dataUrl);
    if(stream) stream.getTracks().forEach(t=>t.stop());
    window.location.href = `meeting.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(userName)}&useAvatar=true`;
  }

  // Go back without saving
  function goBack(){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    window.location.href = `meeting.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(userName)}`;
  }
</script>
</body>
</html>
x
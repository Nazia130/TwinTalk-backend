<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Select Avatar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #181818;
      color: #fff;
      text-align: center;
      padding: 18px;
    }
    h1 { color: #6a0dad; }
    h3 { margin-top: 25px; color: #ddd; }
    .presets {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .presets img, .presets model-viewer {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 12px;
      cursor: pointer;
      border: 2px solid transparent;
      background: #000;
    }
    .presets img:hover, .presets model-viewer:hover {
      border-color: #6a0dad;
    }

    #video {
      width: 320px;
      height: 240px;
      border-radius: 8px;
      background: #000;
      display: block;
      margin: 12px auto;
    }
    #canvas {
      display: none;
      width: 320px;
      height: 240px;
      border-radius: 8px;
      margin: 12px auto;
    }

    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #6a0dad;
      color: #fff;
      cursor: pointer;
      margin: 6px;
      transition: background 0.3s;
    }
    button.gray { background: #555; }
    button:hover { background: #520c9c; }
  </style>

  <!-- ‚úÖ 3D Avatar Support -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <h1>Choose Your Avatar</h1>

  <h3>Preset Avatars</h3>
  <div class="presets">
    <img src="https://tse4.mm.bing.net/th/id/OIP._8y_AjgfPlCos61q1924LgHaHa?pid=Api&P=0&h=180" alt="Male 1" onclick="selectPreset(this.src)">
    <img src="https://tse4.mm.bing.net/th/id/OIP.IkLYdobJ8Ux8CAX0AfuXIQHaHa?pid=Api&P=0&h=180" alt="Male 2" onclick="selectPreset(this.src)">
    <img src="https://img.freepik.com/vector-premium/ilustracion-vectorial-perfil-avatar-mujer-linda_1058532-14546.jpg" alt="Female 1" onclick="selectPreset(this.src)">
    <img src="https://static.vecteezy.com/system/resources/previews/019/837/194/original/smile-american-african-businesswoman-avatar-curly-hair-woman-face-profile-icon-concept-online-support-service-female-cartoon-character-portrait-isolated-flat-icon-png.png" alt="Female 2" onclick="selectPreset(this.src)">

    <!-- ‚úÖ GLB Model Avatar -->
    <model-viewer src="character_avatar.glb" alt="3D Avatar"
      camera-controls auto-rotate
      style="width:120px;height:120px;border-radius:12px;cursor:pointer;"
      onclick="selectGLB('character_avatar.glb')">
    </model-viewer>
  </div>

  <h3>Or Create Custom Avatar</h3>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" width="320" height="240"></canvas>

  <div>
    <button onclick="capture()">üì∏ Capture</button>
    <button id="saveBtn" onclick="saveCaptured()" style="display:none">‚úÖ Save & Use</button>
    <button class="gray" onclick="goBack()">‚¨Ö Back</button>
  </div>

<script>
  /* -------------------------
     1Ô∏è‚É£ Auth Guard
  -------------------------- */
  const user = (() => { try { return JSON.parse(sessionStorage.getItem("user")); } catch(e){ return null; } })();
  if (!user || !user.email) {
    alert("Please login first to select an avatar.");
    window.location.href = "auth.html";
  }

  /* -------------------------
     2Ô∏è‚É£ Params & Elements
  -------------------------- */
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get('room') || '';
  const userName = params.get('name') || user.name || user.email.split('@')[0];

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let stream = null;

  /* -------------------------
     3Ô∏è‚É£ Start webcam preview
  -------------------------- */
  navigator.mediaDevices.getUserMedia({ video:true, audio:false })
    .then(s => { stream = s; video.srcObject = s; })
    .catch(e => { console.warn("Camera not available:", e); });

  /* -------------------------
     4Ô∏è‚É£ Choose preset avatar
  -------------------------- */
  function selectPreset(src){
    localStorage.setItem('userAvatar', src);
    cleanupStream();
    redirectToMeeting(true);
  }

  /* -------------------------
     5Ô∏è‚É£ Choose 3D GLB avatar
  -------------------------- */
  function selectGLB(path){
    localStorage.setItem('userAvatar', path);
    cleanupStream();
    redirectToMeeting(true);
  }

  /* -------------------------
     6Ô∏è‚É£ Capture webcam as cartoon avatar
  -------------------------- */
  function capture(){
    if(!video.videoWidth){ alert("Camera not ready."); return; }
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // simple cartoon effect (reduce colors)
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const d = imgData.data, levels = 6;
    for(let i=0;i<d.length;i+=4){
      d[i]   = Math.floor(d[i] / (256/levels)) * (256/levels);
      d[i+1] = Math.floor(d[i+1] / (256/levels)) * (256/levels);
      d[i+2] = Math.floor(d[i+2] / (256/levels)) * (256/levels);
    }
    ctx.putImageData(imgData,0,0);

    document.getElementById('saveBtn').style.display = 'inline-block';
    video.style.display = 'none';
    canvas.style.display = 'block';
  }

  /* -------------------------
     7Ô∏è‚É£ Save captured snapshot
  -------------------------- */
  function saveCaptured(){
    const dataUrl = canvas.toDataURL('image/png');
    localStorage.setItem('userAvatar', dataUrl);
    cleanupStream();
    redirectToMeeting(true);
  }

  /* -------------------------
     8Ô∏è‚É£ Back button handler
  -------------------------- */
  function goBack(){
    cleanupStream();
    redirectToMeeting(false);
  }

  /* -------------------------
     9Ô∏è‚É£ Helpers
  -------------------------- */
  function cleanupStream(){
    if(stream) stream.getTracks().forEach(t => t.stop());
  }

  function redirectToMeeting(useAvatar){
    const url = `meeting.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(userName)}${useAvatar ? "&useAvatar=true" : ""}`;
    window.location.href = url;
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting History - TwinTalk</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1a2a6c;
            --secondary: #4a569d;
            --accent: #00b4db;
            --light: #f8f9fa;
            --dark: #333;
            --gray: #666;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: var(--primary);
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Stats Section */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .stat-icon.meetings {
            background: rgba(26, 42, 108, 0.1);
            color: var(--primary);
        }

        .stat-icon.duration {
            background: rgba(0, 180, 219, 0.1);
            color: var(--accent);
        }

        .stat-icon.recents {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Filters Section */
        .filters {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        /* History Container */
        .history-container {
            display: grid;
            gap: 20px;
        }

        .meeting-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }

        .meeting-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .meeting-card-header {
            padding: 15px 20px;
            background: rgba(26, 42, 108, 0.03);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meeting-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meeting-date {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .meeting-card-body {
            padding: 20px;
        }

        .meeting-summary {
            color: var(--dark);
            line-height: 1.6;
            margin-bottom: 15px;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .meeting-summary.expanded {
            max-height: none;
        }

        .read-more {
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            margin-top: 5px;
        }

        .meeting-card-footer {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.02);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meeting-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-btn {
            background: var(--primary);
            color: white;
        }

        .view-btn:hover {
            background: var(--secondary);
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .empty-state p {
            max-width: 500px;
            margin: 0 auto 20px;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(26, 42, 108, 0.2);
            border-left: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .filters {
                flex-direction: column;
                align-items: flex-start;
            }

            .meeting-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .meeting-card-footer {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .meeting-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-history"></i>
                Meeting History
            </h1>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="window.location.href='index.html'">
                    <i class="fas fa-arrow-left"></i>
                    Back to Home
                </button>
                <button class="btn btn-primary" onclick="window.location.href='meeting.html'">
                    <i class="fas fa-plus"></i>
                    New Meeting
                </button>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon meetings">
                    <i class="fas fa-video"></i>
                </div>
                <div class="stat-value" id="totalMeetings">0</div>
                <div class="stat-label">Total Meetings</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon duration">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" id="avgDuration">0m</div>
                <div class="stat-label">Avg. Duration</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon recents">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-value" id="recentMeetings">0</div>
                <div class="stat-label">Last 7 Days</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Sort By</label>
                <select class="filter-select" id="sortSelect">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title">Meeting Title</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Time Range</label>
                <select class="filter-select" id="timeRangeSelect">
                    <option value="all">All Time</option>
                    <option value="week">Last Week</option>
                    <option value="month">Last Month</option>
                    <option value="year">Last Year</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" class="filter-input" id="searchInput" placeholder="Search meetings...">
            </div>
        </div>

        <!-- History Container -->
        <div class="history-container" id="historyContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading your meeting history...</p>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const SUPABASE_URL = "https://qdaegqzevidezclgvpcz.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkYWVncXpldmlkZXpjbGd2cGN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1ODYyNDEsImV4cCI6MjA3ODE2MjI0MX0.jc7lubD4JhJWmYiHr6gy2hb-up4-cANI47DdDm7wrO0";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let meetingData = [];

        async function loadHistory() {
            const container = document.getElementById("historyContainer");
            const user = JSON.parse(sessionStorage.getItem("user") || "{}");
            const userEmail = (user.email || "").toLowerCase();

            if (!userEmail) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-user-slash"></i>
                        </div>
                        <h3>Authentication Required</h3>
                        <p>Please log in to view your meeting history.</p>
                        <button class="btn btn-primary" onclick="window.location.href='index.html'">
                            <i class="fas fa-sign-in-alt"></i>
                            Go to Login
                        </button>
                    </div>
                `;
                return;
            }

            try {
                const { data, error } = await supabase
                    .from("summaries")
                    .select("*")
                    .eq("user_email", userEmail)
                    .order("created_at", { ascending: false });

                if (error) throw error;

                meetingData = data || [];
                
                // Update stats
                updateStats(meetingData);
                
                if (!meetingData.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <h3>No Meeting History Yet</h3>
                            <p>Your meeting summaries will appear here once you start using TwinTalk for your meetings.</p>
                            <button class="btn btn-primary" onclick="window.location.href='meeting.html'">
                                <i class="fas fa-plus"></i>
                                Start Your First Meeting
                            </button>
                        </div>
                    `;
                    return;
                }

                renderMeetings(meetingData);
                
                // Add event listeners for filters
                document.getElementById('sortSelect').addEventListener('change', applyFilters);
                document.getElementById('timeRangeSelect').addEventListener('change', applyFilters);
                document.getElementById('searchInput').addEventListener('input', applyFilters);
                
            } catch (err) {
                console.error("History load error:", err);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Error Loading History</h3>
                        <p>We encountered an issue while loading your meeting history. Please try again later.</p>
                        <button class="btn btn-primary" onclick="loadHistory()">
                            <i class="fas fa-redo"></i>
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function updateStats(data) {
            document.getElementById('totalMeetings').textContent = data.length;
            
            // Calculate recent meetings (last 7 days)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const recentCount = data.filter(item => new Date(item.created_at) > oneWeekAgo).length;
            document.getElementById('recentMeetings').textContent = recentCount;
            
            // For demo purposes, set a placeholder for average duration
            document.getElementById('avgDuration').textContent = "45m";
        }

        function renderMeetings(data) {
            const container = document.getElementById("historyContainer");
            container.innerHTML = "";

            data.forEach((item, index) => {
                const card = document.createElement("div");
                card.className = "meeting-card";

                const summaryText = item.summary || "No summary recorded.";
                const summaryPreview = summaryText.length > 200 
                    ? summaryText.slice(0, 200) + "..." 
                    : summaryText;

                const createdAt = new Date(item.created_at);
                const formattedDate = createdAt.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                const formattedTime = createdAt.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                card.innerHTML = `
                    <div class="meeting-card-header">
                        <div class="meeting-title">
                            <i class="fas fa-video"></i>
                            ${item.meeting_id || "Unnamed Meeting"}
                        </div>
                        <div class="meeting-date">
                            <i class="far fa-calendar"></i> ${formattedDate} at ${formattedTime}
                        </div>
                    </div>
                    <div class="meeting-card-body">
                        <div class="meeting-summary">
                            ${summaryPreview.replace(/\n/g, "<br>")}
                        </div>
                        ${summaryText.length > 200 ? '<button class="read-more">Read more</button>' : ''}
                    </div>
                    <div class="meeting-card-footer">
                        <div class="meeting-actions">
                            <button class="action-btn view-btn" data-index="${index}">
                                <i class="fas fa-eye"></i>
                                View Details
                            </button>
                            <button class="action-btn delete-btn" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Add event listeners
            container.querySelectorAll(".view-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const idx = e.target.closest('.view-btn').dataset.index;
                    const note = data[idx];
                    viewFull(note);
                });
            });

            container.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.closest('.delete-btn').dataset.id;
                    await deleteNote(id);
                });
            });

            // Add read more functionality
            container.querySelectorAll(".read-more").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const summaryElement = e.target.previousElementSibling;
                    if (summaryElement.classList.contains('expanded')) {
                        summaryElement.classList.remove('expanded');
                        e.target.textContent = 'Read more';
                    } else {
                        summaryElement.classList.add('expanded');
                        e.target.textContent = 'Read less';
                    }
                });
            });
        }

        function applyFilters() {
            const sortBy = document.getElementById('sortSelect').value;
            const timeRange = document.getElementById('timeRangeSelect').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredData = [...meetingData];
            
            // Apply search filter
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    (item.meeting_id || "").toLowerCase().includes(searchTerm) ||
                    (item.summary || "").toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply time range filter
            if (timeRange !== 'all') {
                const now = new Date();
                let startDate;
                
                switch(timeRange) {
                    case 'week':
                        startDate = new Date(now.setDate(now.getDate() - 7));
                        break;
                    case 'month':
                        startDate = new Date(now.setMonth(now.getMonth() - 1));
                        break;
                    case 'year':
                        startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                        break;
                }
                
                filteredData = filteredData.filter(item => new Date(item.created_at) >= startDate);
            }
            
            // Apply sorting
            switch(sortBy) {
                case 'newest':
                    filteredData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'oldest':
                    filteredData.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'title':
                    filteredData.sort((a, b) => (a.meeting_id || "").localeCompare(b.meeting_id || ""));
                    break;
            }
            
            renderMeetings(filteredData);
        }

        function viewFull(note) {
            if (!note) return alert("Note not found.");
            
            const popup = window.open("", "_blank", "width=700,height=600,scrollbars=yes,resizable=yes");
            popup.document.write(`
                <html>
                    <head>
                        <title>${note.meeting_id || "Meeting Summary"}</title>
                        <style>
                            body {
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                padding: 30px;
                                line-height: 1.6;
                                color: #333;
                                background: #f8f9fa;
                            }
                            .container {
                                max-width: 800px;
                                margin: 0 auto;
                                background: white;
                                border-radius: 10px;
                                padding: 30px;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            }
                            h1 {
                                color: #1a2a6c;
                                margin-bottom: 10px;
                                border-bottom: 2px solid #00b4db;
                                padding-bottom: 10px;
                            }
                            .meta {
                                color: #666;
                                margin-bottom: 20px;
                                font-size: 0.9rem;
                            }
                            .summary {
                                background: #f8f9fa;
                                padding: 20px;
                                border-radius: 8px;
                                border-left: 4px solid #00b4db;
                                white-space: pre-wrap;
                                line-height: 1.8;
                            }
                            .actions {
                                margin-top: 20px;
                                text-align: center;
                            }
                            .btn {
                                padding: 10px 20px;
                                background: #1a2a6c;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-weight: 500;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1><i class="fas fa-file-alt"></i> ${note.meeting_id || "Meeting Summary"}</h1>
                            <div class="meta">
                                <strong>Date:</strong> ${new Date(note.created_at).toLocaleString()} | 
                                <strong>User:</strong> ${note.user_email || "Unknown"}
                            </div>
                            <div class="summary">${note.summary || "No summary available."}</div>
                            <div class="actions">
                                <button class="btn" onclick="window.print()"><i class="fas fa-print"></i> Print Summary</button>
                            </div>
                        </div>
                    </body>
                </html>
            `);
        }

        async function deleteNote(id) {
            if (!confirm("Are you sure you want to delete this meeting summary? This action cannot be undone.")) return;

            try {
                const { error } = await supabase.from("summaries").delete().eq("id", id);
                if (error) throw error;
                
                // Remove from local data
                meetingData = meetingData.filter(item => item.id !== id);
                
                // Update UI
                updateStats(meetingData);
                applyFilters();
                
                // Show success message
                showNotification("Meeting summary deleted successfully.", "success");
            } catch (err) {
                console.error("Delete failed:", err);
                showNotification("Error deleting meeting summary. Please try again.", "error");
            }
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
            `;
            
            if (type === 'success') {
                notification.style.background = '#28a745';
            } else {
                notification.style.background = '#dc3545';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Initialize the page
        loadHistory();
    </script>
</body>
</html>